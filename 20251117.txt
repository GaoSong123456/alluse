<template>
  <div class="org-management-container">
    <!-- 全局loading -->
    <a-spin :spinning="globalLoading" tip="加载中...">
      <a-row class="full-height">
        <!-- 左侧树形结构 (30%) -->
        <a-col :span="7" class="tree-container">
          <a-spin :spinning="treeLoading" tip="加载中...">
            <a-tree
              ref="treeRef"
              :treeData="treeData"
              :expandedKeys="expandedKeys"
              :selectedKeys="selectedKeys"
              @select="handleTreeSelect"
              @expand="handleTreeExpand"
              @rightClick="handleRightClick"
              :titleRender="titleRender"
              :disabled="treeLoading"
              :autoExpandparent="false"
            />
          </a-spin>
          
          <!-- 右键菜单 -->
          <a-dropdown
            :visible="contextMenuVisible"
            :trigger="['contextmenu']"
            placement="bottomLeft"
            @visibleChange="handleContextMenuVisibleChange"
          >
            <template #overlay>
              <a-menu @click="handleContextMenuClick">
                <a-menu-item v-if="showAddChild" key="addChild">新增子节点</a-menu-item>
                <a-menu-item v-if="showAddSibling" key="addSibling">新增同级节点</a-menu-item>
                <a-menu-item v-if="showEdit" key="edit">修改节点</a-menu-item>
                <a-menu-item v-if="showDelete" key="delete">删除节点</a-menu-item>
                <a-menu-item v-if="showRefresh" key="refresh">刷新节点</a-menu-item>
              </a-menu>
            </template>
	    <!-- 用于定位的空元素 -->
	    <div ref="contextMenuAnchor" style="position: absolute; z-index: 1000;"></div>
          </a-dropdown>
        </a-col>

        <!-- 右侧内容区域 (70%) -->
        <a-col :span="17" class="content-container">
          <a-spin :spinning="contentLoading" tip="加载中...">
            <a-tabs 
              v-if="selectedNode && !isRootNode(selectedNode)" 
              :activeKey="activeTabKey" 
              @change="handleTabChange"
              :disabled="contentLoading"
            >
              <!-- 组织信息表单 -->
              <a-tab-pane key="info" tab="组织信息">
                <a-form
                  ref="detailFormRef"
                  :model="formData"
                  :label-col="{ span: 6 }"
                  :wrapper-col="{ span: 16 }"
                >
                <a-row>
                  <a-col :span="12">
                    <a-form-item label="组织名称" name="orgName" 
                                :rules="[{ required: true, message: '请输入组织名称' }]">
                      <a-input v-model="formData.orgName" />
                    </a-form-item>
                  </a-col>
                  <a-col :span="12">  
                    <a-form-item label="排序号" name="sort"
                                :rules="[{ 
                                  validator: (rule, value, callback) => {
                                    if (value === null || value === undefined || value === '') {
                                      callback()
                                      return
                                    }
                                    if (!Number.isInteger(+value)) {
                                      callback('请输入整数')
                                    } else {
                                      callback()
                                    }
                                  }
                                }]">
                      <a-input v-model="formData.sort" placeholder="请输入整数，非必填" />
                    </a-form-item>
                  </a-col>
                 </a-row>
                 <a-row>
                   <a-col :span="12">
                     <a-form-item label="组织层级" name="orgLevel">
                      <a-input v-model.number="formData.orgLevel" disabled />
                    </a-form-item>
                   </a-col>
                   <a-col :span="12">
                     <a-form-item label="是否自动获取角色" name="isAutoGetRole">
                      <a-select v-model="formData.isAutoGetRole" placeholder="请选择">
                        <a-select-option value="1">是</a-select-option>
                        <a-select-option value="0">否</a-select-option>
                      </a-select>
                    </a-form-item>
                   </a-col>
                 </a-row>
                  
                 <a-row>
                   <a-col :span="12">
                     <a-form-item label="角色来源" name="roleOrigin">
                      <a-input v-model="formData.roleOrigin" />
                    </a-form-item>
                   </a-col>
                   <a-col :span="12">
                     <a-form-item label="组织负责人" name="orgLeader">
                      <a-input v-model="formData.orgLeader" />
                    </a-form-item>
                   </a-col>
                 </a-row>

                 <a-row>
                   <a-col :span="12">
                     <a-form-item label="组织角色" name="orgRole">
                      <a-input v-model="formData.orgRole" />
                    </a-form-item>
                   </a-col>
                   <a-col :span="12">
                    <a-form-item label="备注" name="remark">
                      <a-textarea v-model="formData.remark" rows="4" />
                    </a-form-item>
                   </a-col>
                 </a-row>

                 <a-row>
                   <a-col :span="12">
                     <a-form-item label="类型" name="type">
                      <a-input v-model="formData.type" />
                    </a-form-item>
                   </a-col>
                 </a-row>
                  
                 <a-row>
                    <a-col :span="24" style="display: flex; justify-content: center;margin-top: 4px; margin-bottom: 20px;">
                      <a-button  type="primary" @click="handleFormSubmit" :loading="formLoading">保存</a-button>
                    </a-col>
                </a-row> 
                </a-form>
              </a-tab-pane>

              <!-- 下级组织表格 -->
              <a-tab-pane key="children" tab="下级组织列表">
                <div class="table-operations">
                  <a-button 
                    type="primary" 
                    @click="handleAddChildFromTable"
                    :loading="tableLoading"
                  >
                    新增
                  </a-button>
                  <a-button 
                    danger 
                    @click="handleBatchDelete" 
                    :disabled="selectedRowKeys.length === 0 || tableLoading"
                    :loading="tableLoading"
                  >
                    删除
                  </a-button>
                  <a-button 
                    type="primary" 
                    @click="handleEditFromTable" 
                    :disabled="selectedRowKeys.length !== 1 || tableLoading"
                    :loading="tableLoading"
                  >
                    编辑
                  </a-button>
                </div>
                <a-table
                  :columns="childColumns"
                  :data-source="childTableData"
                  :row-key="record => record.id"
                  :row-selection="{
                    selectedRowKeys,
                    onChange: handleRowSelectionChange,
                    disabled: tableLoading
                  }"
                  :loading="tableLoading"
                >
                  <!-- <template #operation="record">
                    <a-button 
                      type="link" 
                      @click="handleEditChild(record)"
                      :disabled="tableLoading"
                    >
                      编辑
                    </a-button>
                    <a-button 
                      type="link" 
                      danger 
                      @click="handleDeleteChild(record)"
                      :disabled="tableLoading"
                    >
                      删除
                    </a-button>
                  </template> -->
                </a-table>
              </a-tab-pane>
            </a-tabs>
          </a-spin>
        </a-col>
      </a-row>
    </a-spin>

    <!-- 通用弹窗表单 -->
    <a-modal
      :visible="modalVisible"
      :title="modalTitle"
      :confirm-loading="modalLoading"
      @ok="handleModalSubmit"
      @cancel="modalVisible = false"
    >
      <a-form
        ref="modalFormRef"
        :model="modalFormData"
        :label-col="{ span: 6 }"
        :wrapper-col="{ span: 16 }"
      >
        <a-form-item label="组织名称" name="orgName" 
                     :rules="[{ required: true, message: '请输入组织名称' }]">
          <a-input v-model="modalFormData.orgName" />
        </a-form-item>
        <a-form-item label="排序号" name="sort"
                     :rules="[{ 
                       validator: (rule, value, callback) => {
                         if (value === null || value === undefined || value === '') {
                           callback()
                           return
                         }
                         if (!Number.isInteger(+value)) {
                           callback('请输入整数')
                         } else {
                           callback()
                         }
                       }
                     }]">
          <a-input v-model="modalFormData.sort" placeholder="请输入整数" />
        </a-form-item>
        <a-form-item label="是否自动获取角色" name="isAutoGetRole">
          <a-select v-model="modalFormData.isAutoGetRole" placeholder="请选择">
            <a-select-option value="1">是</a-select-option>
            <a-select-option value="0">否</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="角色来源" name="roleOrigin">
          <a-input v-model="modalFormData.roleOrigin" />
        </a-form-item>
        <a-form-item label="组织负责人" name="orgLeader">
          <a-input v-model="modalFormData.orgLeader" />
        </a-form-item>
        <a-form-item label="组织角色" name="orgRole">
          <a-input v-model="modalFormData.orgRole" />
        </a-form-item>
        <a-form-item label="备注" name="remark">
          <a-textarea v-model="modalFormData.remark" rows="4" />
        </a-form-item>
        <a-form-item label="类型" name="type">
          <a-input v-model="modalFormData.type" />
        </a-form-item>
      </a-form>
    </a-modal>
  </div>
</template>

<script>
import { Tree, Table, Tabs, Form, Input, InputNumber, Select, Button, Textarea, Dropdown, Menu, message, Col, Row, Spin, Modal } from 'ant-design-vue'
import { 
  getGenericPlanOrgInfoTree, 
  addGenericPlanOrgInfo, 
  updateGenericPlanOrgInfo, 
  deleteInfoByIds, 
  getGenericPlanOrgInfoChildById, 
  getGenericPlanOrgInfoById } from "./service";

export default {
  name: "genericPlanOrgInfo",
  components: {
    'a-tree': Tree,
    'a-table': Table,
    'a-tabs': Tabs,
    'a-tab-pane': Tabs.TabPane,
    'a-form': Form,
    'a-form-item': Form.Item,
    'a-input': Input,
    'a-input-number': InputNumber,
    'a-select': Select,
    'a-select-option': Select.Option,
    'a-button': Button,
    'a-textarea': Textarea,
    'a-dropdown': Dropdown,
    'a-menu': Menu,
    'a-menu-item': Menu.Item,
    'a-col': Col,
    'a-row': Row,
    'a-spin': Spin,
    'a-modal': Modal
  },
  data() {
    return {
      // 树形数据
      treeData: [],
      selectedKeys: [],
      expandedKeys: [],
      selectedNode: null,
      
      // 右键菜单相关
      contextMenuVisible: false,
      currentRightClickNode: null,
      
      // 表单数据
      formData: {
        id: null,
        pId: null,
        orgName: '',
        orgLevel: 0,
        isAutoGetRole: 0,
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        type: '',
        sort: null
      },
      
      // 标签页
      activeTabKey: 'info',
      
      // 子节点表格
      childColumns: [
        { title: '组织名称', dataIndex: 'orgName', key: 'orgName' },
        { title: '排序号', dataIndex: 'sort', key: 'sort' },
        { title: '组织层级', dataIndex: 'orgLevel', key: 'orgLevel' },
        { title: '负责人', dataIndex: 'orgLeader', key: 'orgLeader' },
        // { title: '操作', key: 'operation', scopedSlots: { customRender: 'operation' } }
      ],
      childTableData: [],
      selectedRowKeys: [],
      
      // 弹窗相关
      modalVisible: false,
      modalTitle: '',
      modalFormData: {
        id: null,
        pId: null,
        orgName: '',
        orgLevel: 0,
        isAutoGetRole: 0,
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        type: '',
        sort: null
      },
      modalAction: '', // addChild, addSibling, edit
      modalTargetNode: null,
      
      // Loading状态
      globalLoading: false,
      treeLoading: false,
      contentLoading: false,
      formLoading: false,
      tableLoading: false,
      modalLoading: false
    }
  },
  computed: {
    // 右键菜单显示控制
    showAddChild() {
      if (!this.currentRightClickNode) return false
      return this.isRootNode(this.currentRightClickNode) || !this.isLeafNode(this.currentRightClickNode)
    },
    showAddSibling() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showEdit() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showDelete() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showRefresh() {
      return !!this.currentRightClickNode
    }
  },
  mounted() {
    
  },
  created(){
    this.loadFullTreeData()
  },
  methods: {
    // 加载完整树形数据
    loadFullTreeData() {
      this.treeLoading = true
      getGenericPlanOrgInfoTree({}).then(res => {
        if (res.data.success) {
          this.treeData = this.convertToTreeFormat(res.data.data)
          this.expandedKeys = []
        }
       }); 
      this.treeLoading = false;
    },
    
    // 加载单个节点及子节点数据
    loadNodeAndChildren(nodeId) {
      this.treeLoading = true
      const data = {id:nodeId};
      getGenericPlanOrgInfoTree(data).then(res => {
        if (res.data.success) {
          this.updateNodeChildren(this.treeData, nodeId, res.data.data.children)
          this.expandNode(nodeId)
        }
       }); 
      this.treeLoading = false;
    },
    
    // 仅更新节点的children数据
    updateNodeChildren(tree, targetId, newChildren) {
      return tree.map(node => {
        if (node.id === targetId) {
          return {
            ...node,
            children: newChildren ? this.convertToTreeFormat(newChildren) : []
          }
        }
        if (node.children && node.children.length > 0) {
          return {
            ...node,
            children: this.updateNodeChildren(node.children, targetId, newChildren)
          }
        }
        return node
      })
    },
    
    // 转换为树形组件需要的格式
    convertToTreeFormat(data) {
      return data.map(item => ({
        ...item,
        key: item.id,
        title: item.orgName,
        children: item.children ? this.convertToTreeFormat(item.children) : []
      }))
    },
    
    // 树形节点选择
    handleTreeSelect(selectedKeys, info) {
      const node = info.node?.dataRef
      if (!node) {
        this.selectedNode = null
        this.selectedKeys = []
        return
      }
      
      if (this.isRootNode(node)) {
        this.selectedKeys = []
        this.selectedNode = null
        return
      }
      
      this.selectedKeys = selectedKeys
      this.selectedNode = node
      this.activeTabKey = 'info'
      this.loadNodeDetail(node.id)
    },
    
    // 树形节点展开/折叠事件
    handleTreeExpand(expandedKeys) {
      this.expandedKeys = expandedKeys
    },
    
    // 强制展开指定节点
    expandNode(nodeId) {
      if (!this.expandedKeys.includes(nodeId)) {
        this.expandedKeys = [...this.expandedKeys, nodeId]
      }
    },
    
    // 加载节点详情
    loadNodeDetail(id) {
	    this.contentLoading = true
      getGenericPlanOrgInfoById({id:id}).then(res => {
        if (res.data.success) {
          this.formData = { ...res.data.data }
          this.loadChildTableData(id)
        }
       }); 
      this.contentLoading = false;
    },
    
    // 加载子节点表格数据
    loadChildTableData(id) {
      this.tableLoading = true
      getGenericPlanOrgInfoChildById({id:id}).then(res => {
        if (res.data.success) {
          this.childTableData = res.data.data
          this.selectedRowKeys = []
        }
       }); 
      this.tableLoading = false;
    },
    
    // 标签页切换
    handleTabChange(key) {
      this.activeTabKey = key
      if (key === 'children' && this.selectedNode) {
        this.loadChildTableData(this.selectedNode.id)
      }
    },
    
// 表单提交（标签页操作，刷新全树）
handleFormSubmit() {
  this.$refs.detailFormRef.validateFields((err) => {
    if (!err) {
      // 校验通过，执行提交逻辑
      this.formLoading = true;
      if (this.formData.id) {
	updateGenericPlanOrgInfo(this.formData).then(res => {
	  if (res.data.success) {
              this.$message.success('修改成功')
              const currentExpanded = [...this.expandedKeys]
              this.loadFullTreeData()
              this.expandedKeys = currentExpanded
              if (this.selectedNode) {
                this.loadNodeDetail(this.selectedNode.id)
              }
            } else {
              this.$message.error(res.data.message);
            }
	    this.formLoading = false;
	});
      } else {
	addGenericPlanOrgInfo(this.formData).then(res => {
	  if (res.data.success) {
              this.$message.success('新增成功')
              const currentExpanded = [...this.expandedKeys]
              this.loadFullTreeData()
              this.expandedKeys = currentExpanded
              if (this.selectedNode) {
                this.loadNodeDetail(this.selectedNode.id)
              }
            } else {
              this.$message.error(res.data.message);
            }
	    this.formLoading = false;
	});
      }
    } else {
      this.$message.error('表单校验失败，请检查输入');
    }
  });
},
  
    
    // 右键菜单点击处理
    handleContextMenuClick({ key }) {
      const node = this.currentRightClickNode
      if (!node) return
      
      this.contextMenuVisible = false
      
      switch (key) {
        case 'addChild':
          this.openAddChildModal(node)
          break
        case 'addSibling':
          this.openAddSiblingModal(node)
          break
        case 'edit':
          this.openEditModal(node)
          break
        case 'delete':
          this.handleRightClickDelete(node)
          break
        case 'refresh':
          this.loadNodeAndChildren(node.id)
          break
      }
    },
    
    // 打开新增子节点弹窗
    openAddChildModal(parentNode) {
      this.modalAction = 'addChild'
      this.modalTargetNode = parentNode
      this.modalTitle = '新增子节点'
      this.modalFormData = {
        id: null,
        pId: parentNode.id,
        orgName: '',
        orgLevel: parentNode.orgLevel + 1,
        isAutoGetRole: 0,
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        type: '',
        sort: null
      }
      this.modalVisible = true
    },
    
    // 打开新增同级节点弹窗
    openAddSiblingModal(node) {
      this.modalAction = 'addSibling'
      this.modalTargetNode = node
      this.modalTitle = '新增同级节点'
      this.modalFormData = {
        id: null,
        pId: node.pId,
        orgName: '',
        orgLevel: node.orgLevel,
        isAutoGetRole: 0,
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        type: '',
        sort: null
      }
      this.modalVisible = true
    },
    
    // 打开编辑节点弹窗
    openEditModal(node) {
      this.modalAction = 'edit'
      this.modalTargetNode = node
      this.modalTitle = '修改节点'
      this.modalFormData = { ...node }
      this.modalVisible = true
    },
    
  // 弹窗提交处理
 handleModalSubmit() {
  this.$refs.modalFormRef.validateFields((err) => {
    if (!err) {
      this.modalLoading = true;
      if (this.modalAction === 'edit') {
        updateGenericPlanOrgInfo(this.modalFormData).then(res => {
          if (res.data.success) {
            this.$message.success('修改成功')
            this.loadNodeAndChildren(this.modalTargetNode.pId)
            this.expandNode(this.modalTargetNode.pId)
            this.modalVisible = false
          } else {
            this.$message.error(res.data.message);
          }
	  this.modalLoading = false
        });
      } else {
        addGenericPlanOrgInfo(this.modalFormData).then(res => {
          if (res.data.success) {
            this.$message.success('新增成功')
            this.loadNodeAndChildren(this.modalTargetNode.id)
            this.expandNode(this.modalTargetNode.id)
            this.modalVisible = false
          } else {
            this.$message.error(res.data.message);
          }
	  this.modalLoading = false
        });
      }
    } else {
      this.$message.error('表单校验失败，请检查输入');
    }
  });
}
    
    // 右键删除节点
    handleRightClickDelete(node) {
      Modal.confirm({
        title: '确认删除',
        content: `确定要删除节点吗？`,
        okText: '确定',
        cancelText: '取消'
      })
      this.globalLoading = true
      deleteInfoByIds(node.id).then(res => {
        if (res.data.success) {
          this.$message.success('删除成功')
          this.loadNodeAndChildren(node.pId)
          this.expandNode(node.pId)
          this.selectedKeys = []
          this.selectedNode = null
        } else {
          this.$message.error(res.data.message);
        }
      }); 
      this.globalLoading = false
    },
    
    // 表格行选择变化
    handleRowSelectionChange(keys) {
      this.selectedRowKeys = keys
    },
    
    // 表格编辑子节点
    // handleEditChild(record) {
    //   this.formData = { ...record }
    //   this.activeTabKey = 'info'
    // },

     // 新增表格新增按钮处理
     handleAddChildFromTable() {
	 if (!this.selectedNode) return;
	 this.openAddChildModal(this.selectedNode);
     },
    
    // 编辑选中的表格行
    handleEditSelected() {
      const selectedRecord = this.childTableData.find(item => item.id === this.selectedRowKeys[0])
      if (selectedRecord) {
        this.formData = { ...selectedRecord }
        this.activeTabKey = 'info'
      }
    },

    // 新增表格编辑按钮处理
    handleEditFromTable() {
      const selectedRecord = this.childTableData.find(
	item => item.id === this.selectedRowKeys[0]
      );
      if (selectedRecord) {
	this.openEditModal(selectedRecord);
      }
    }
    
    // 表格删除子节点
    // handleDeleteChild(record) {
    //   Modal.confirm({
    //     title: '确认删除',
    //     content: `确定要删除节点吗？`,
    //     okText: '确定',
    //     cancelText: '取消'
    //   })
    //   this.tableLoading = true
    //   deleteInfoByIds(record.id).then(res => {
    //     if (res.data.success) {
    //       this.$message.success('删除成功')
    //       this.loadFullTreeData()
    //       if (this.selectedNode) {
    //         this.expandNode(this.selectedNode.id)
    //         this.loadChildTableData(this.selectedNode.id)
    //       }
    //     } else {
    //       this.$message.error(res.data.message);
    //     }
    //   });
    //   this.tableLoading = false
    // },
    
    // 表格批量删除
    handleBatchDelete() {
      if (this.selectedRowKeys.length === 0){
        this.$message.error("请选择要删除的行数据");
        return
      } 
      Modal.confirm({
        title: '批量删除',
        content: `确定要删除吗？`,
        okText: '确定',
        cancelText: '取消'
      })
      this.tableLoading = true
      deleteInfoByIds(this.selectedRowKeys.join(',')).then(res => {
        if (res.data.success) {
          this.$message.success('批量删除成功')
          this.loadFullTreeData()
          if (this.selectedNode) {
            this.expandNode(this.selectedNode.id)
            this.loadChildTableData(this.selectedNode.id)
          }
        } else {
          this.$message.error(res.data.message);
        }
      });
      this.tableLoading = false
    },
    
    // 右键菜单显示/隐藏
    handleRightClick({ event, node }) {
      event.preventDefault();
      this.currentRightClickNode = node.dataRef;
      this.selectedKeys = [node.key];
      this.selectedNode = node.dataRef;
	  
      const anchor = this.$refs.contextMenuAnchor;
      if (anchor) {
       anchor.style.left = `${event.clientX}px`;
       anchor.style.top = `${event.clientY}px`;
      }
      this.contextMenuVisible = true;
    },
    
    handleContextMenuVisibleChange(visible) {
      this.contextMenuVisible = visible;
      if (!visible) {
        this.currentRightClickNode = null
      }
    },
    
    // 根节点判断
    isRootNode(node) {
      return node.orgLevel === 0 && node.id === 0
    },
    
    // 叶子节点判断
    isLeafNode(node) {
      return node.orgLevel === 3 && (!node.children || node.children.length === 0)
    },
    
    // 自定义节点渲染
    titleRender(node) {
      return node.orgName
    }
  }
}
</script>

<style scoped>
.org-management-container {
  height: 100vh;
  overflow: hidden;
}

.full-height {
  height: 100%;
}

.tree-container {
  height: 100%;
  border-right: 1px solid #e8e8e8;
  padding: 16px;
  overflow: auto;
}

.content-container {
  height: 100%;
  padding: 16px;
  overflow: auto;
}

.table-operations {
  margin-bottom: 16px;
  display: flex;
  gap: 8px;
}

.ant-spin-nested-loading {
  position: relative;
  z-index: 1;
}
</style>
