<template>
  <div class="org-management-container">
    <!-- 全局loading -->
      <a-row class="full-height">
        <!-- 左侧树形结构 (30%) -->
        <a-col :span="7" class="tree-container">
          <a-spin :spinning="treeLoading" tip="加载中...">
            <a-tree
              ref="treeRef"
              :treeData="treeData"
              :expandedKeys="expandedKeys"
              :selectedKeys="selectedKeys"
              @select="handleTreeSelect"
              @expand="handleTreeExpand"
              @rightClick="handleRightClick"
              :titleRender="titleRender"
              :disabled="treeLoading"
              :autoExpandparent="false"
            />
          </a-spin>

          <!-- 右键菜单 -->
          <a-dropdown
            :visible="contextMenuVisible"
            :trigger="['contextmenu']"
            placement="bottomLeft"
            @visibleChange="handleContextMenuVisibleChange"
          >
            <template #overlay>
              <a-menu @click="handleContextMenuClick">
                <a-menu-item v-if="showAddChild" key="addChild"
                  >新增子节点</a-menu-item
                >
                <a-menu-item v-if="showAddSibling" key="addSibling"
                  >新增同级节点</a-menu-item
                >
                <a-menu-item v-if="showEdit" key="edit">修改节点</a-menu-item>
                <a-menu-item v-if="showDelete" key="delete"
                  >删除节点</a-menu-item
                >
                <a-menu-item v-if="showRefresh" key="refresh"
                  >刷新节点</a-menu-item
                >
              </a-menu>
            </template>
            <!-- 添加一个具有尺寸的锚点元素 -->
            <div
              ref="contextMenuAnchor"
              style="position: fixed; width: 1px; height: 1px; z-index: -1;"
              :style="{ left: anchorX + 'px', top: anchorY + 'px' }"
            ></div>
          </a-dropdown>
        </a-col>

        <!-- 右侧内容区域 (70%) -->
        <a-col :span="17" class="content-container">
          <a-spin :spinning="contentLoading" tip="加载中...">
            <a-tabs
              v-if="selectedNode && !isRootNode(selectedNode)"
              :activeKey="activeTabKey"
              @change="handleTabChange"
              :disabled="contentLoading"
            >
              <!-- 组织信息表单 -->
              <a-tab-pane key="info" tab="组织信息">
                <a-form
                  ref="detailFormRef"
                  :model="formData"
                  :label-col="{ span: 6 }"
                  :wrapper-col="{ span: 16 }"
                >
                  <a-row>
                    <a-col :span="12">
                      <a-form-item
                        label="组织名称"
                        name="orgName"
                        :rules="[{ required: true, message: '请输入组织名称' }]"
                      >
                        <a-input v-model="formData.orgName" placeholder="请输入组织名称" maxLength=85 />
                      </a-form-item>
                    </a-col>
                    <a-col :span="12">
                      <a-form-item 
                        label="组织级别" 
                        name="orgLevel"
                        :rules="[{ required: true, message: '组织级别不能为空' }]"
                      >
                        <a-input-number v-model="formData.orgLevel" style="width: 100%;" disabled />
                      </a-form-item>
                    </a-col>
                  </a-row>
                  <a-row>
                    <a-col :span="12">
                      <a-form-item
                        label="是否自动获取角色"
                        name="isAutoGetRole"
                        :rules="[{ required: true, message: '请选择是否自动获取角色' }]"
                      >
                        <a-select
                          v-model="formData.isAutoGetRole"
                          placeholder="请选择"
                        >
                          <a-select-option value="1">是</a-select-option>
                          <a-select-option value="0">否</a-select-option>
                        </a-select>
                      </a-form-item>
                    </a-col>
                    <a-col :span="12">
                      <a-form-item label="角色来源" name="roleOrigin">
                        <a-input v-model="formData.roleOrigin" />
                      </a-form-item>
                    </a-col>
                  </a-row>

                  <a-row v-if="formData.isAutoGetRole === '0'">
                    <a-col :span="12">
                      <a-form-item label="组织角色" name="orgRole">
                        <commonchooseuser ref="chooseuser" 
                          v-model="formData.orgRole"
                          :default-data="defaultData()"
                          v-on:getdata="(val)=>getdata(val)">
                        </commonchooseuser>
                      </a-form-item>
                    </a-col>
                  </a-row>

                  <a-row>
                    <a-col :span="12">
                      <a-form-item
                        label="排序"
                        name="sort"
                        :rules="[
                          {
                            validator: (rule, value, callback) => {
                              if (
                                value === null ||
                                value === undefined ||
                                value === ''
                              ) {
                                callback();
                                return;
                              }
                              if (!Number.isInteger(+value)) {
                                callback('请输入整数');
                              } else {
                                callback();
                              }
                            },
                          },
                        ]"
                      >
                        <a-input-number
                          v-model="formData.sort"
                          :min="0"
                          placeholder="请输入排序"
                          style="width: 100%;"
                        />
                      </a-form-item>
                    </a-col>
                    <a-col :span="12">
                      <a-form-item label="备注" name="remark">
                        <a-textarea
                          v-model="formData.remark"
                          :auto-size="{ minRows: 3, maxRows: 6 }"
                          placeholder="请输入备注"
                          maxLength=1333
                        />
                      </a-form-item>
                    </a-col>
                  </a-row>

                  <a-row>
                    <a-col
                      :span="24"
                      style="
                        display: flex;
                        justify-content: center;
                        margin-top: 4px;
                        margin-bottom: 20px;
                      "
                    >
                      <a-button
                        type="primary"
                        @click="handleFormSubmit"
                        :loading="formLoading"
                        >保存</a-button
                      >
                    </a-col>
                  </a-row>
                </a-form>
              </a-tab-pane>

              <!-- 下级组织表格 -->
              <a-tab-pane key="children" tab="下级组织列表">
                <div class="table-operations">
                  <a-button
                    type="primary"
                    @click="handleAddChildFromTable"
                    :loading="tableLoading"
                  >
                    新增
                  </a-button>
                  <a-button
                    danger
                    @click="handleBatchDelete"
                    :disabled="selectedRowKeys.length === 0 || tableLoading"
                    :loading="tableLoading"
                  >
                    删除
                  </a-button>
                  <a-button
                    type="primary"
                    @click="handleEditFromTable"
                    :disabled="selectedRowKeys.length !== 1 || tableLoading"
                    :loading="tableLoading"
                  >
                    编辑
                  </a-button>
                </div>
                <a-table
                  :columns="childColumns"
                  :data-source="childTableData"
                  :pagination="false"
                  :row-key="(record) => record.id"
                  :row-selection="{
                    selectedRowKeys,
                    onChange: handleRowSelectionChange,
                    disabled: tableLoading,
                  }"
                  :loading="tableLoading"
                >
                  <!-- <template #operation="record">
                    <a-button 
                      type="link" 
                      @click="handleEditChild(record)"
                      :disabled="tableLoading"
                    >
                      编辑
                    </a-button>
                    <a-button 
                      type="link" 
                      danger 
                      @click="handleDeleteChild(record)"
                      :disabled="tableLoading"
                    >
                      删除
                    </a-button>
                  </template> -->
                </a-table>
                <!-- 通用的分页组件 -->
                <a-pagination
                  show-size-changer
                  v-model="current"
                  :page-size.sync="currentPageSize"
                  :total="total"
                  :show-total="(total, range) => `${range[0]}-${range[1]} of ${total} items`"
                  @showSizeChange="onShowSizeChange"
                  @change="onPaginationChange"
                  class="pagintion_pos"
                  :pageSizeOptions="pageSizeOptions"
                />
              </a-tab-pane>
            </a-tabs>
          </a-spin>
        </a-col>
      </a-row>
    

    <!-- 通用弹窗表单 -->
    <a-modal
      :visible="modalVisible"
      :title="modalTitle"
      :confirm-loading="modalLoading"
      width="50%"
      @ok="handleModalSubmit"
      @cancel="modalVisible = false"
    >
      <a-form
        ref="modalFormRef"
        :model="modalFormData"
        :label-col="{ span: 6 }"
        :wrapper-col="{ span: 16 }"
      >
        <a-row>
          <a-col :span="12">
            <a-form-item
              label="组织名称"
              name="orgName"
              :rules="[{ required: true, message: '请输入组织名称' }]"
            >
              <a-input v-model="modalFormData.orgName" placeholder="请输入组织名称" maxLength=85 />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item 
              label="组织级别" 
              name="orgLevel"
              :rules="[{ required: true, message: '组织级别不能为空' }]"
            >
              <a-input-number v-model="modalFormData.orgLevel" style="width: 100%;" disabled />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row>
          <a-col :span="12">
            <a-form-item 
              label="是否自动获取角色" 
              name="isAutoGetRole"
              :rules="[{ required: true, message: '请选择是否自动获取角色' }]"
            >
              <a-select v-model="modalFormData.isAutoGetRole" placeholder="请选择">
                <a-select-option value="1">是</a-select-option>
                <a-select-option value="0">否</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="角色来源" name="roleOrigin">
              <a-input v-model="modalFormData.roleOrigin" />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row v-if="modalFormData.isAutoGetRole === '0'">
          <a-col :span="12">
            <a-form-item label="组织角色" name="orgRole">
              <commonchooseuser ref="chooseuser" 
                v-model="modalFormData.orgRole"
                :default-data="defaultData()"
                v-on:getdata="(val)=>getdata2(val)">
              </commonchooseuser>
            </a-form-item>
          </a-col>
        </a-row>

        <a-row>
          <a-col :span="12">
            <a-form-item
              label="排序"
              name="sort"
              :rules="[
                {
                  validator: (rule, value, callback) => {
                    if (value === null || value === undefined || value === '') {
                      callback();
                      return;
                    }
                    if (!Number.isInteger(+value)) {
                      callback('请输入整数');
                    } else {
                      callback();
                    }
                  },
                },
              ]"
            >
              <a-input-number v-model="modalFormData.sort" placeholder="请输入排序" style="width: 100%;"/>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="备注" name="remark">
              <a-textarea v-model="modalFormData.remark" rows="4" />
            </a-form-item>
          </a-col>
        </a-row>
      </a-form>
    </a-modal>
  </div>
</template>

<script>
import { 
  getGenericPlanOrgInfoTree, 
  addGenericPlanOrgInfo, 
  updateGenericPlanOrgInfo, 
  deleteInfoByIds, 
  getGenericPlanOrgInfoChildById, 
  getGenericPlanOrgInfoById } from "./service";
import Cookie from "js-cookie";

export default {
  name: "genericPlanOrgInfo",
  components: {
  },
  data() {
    return {
      user:{},
      // 树形数据
      treeData: [],
      selectedKeys: [],
      expandedKeys: [],
      selectedNode: null,
      
      // 右键菜单相关
      contextMenuVisible: false,
      currentRightClickNode: null,
      anchorX: 0,
      anchorY: 0,
      
      // 表单数据
      formData: {
        id: null,
        pId: null,
        orgName: '',
        orgLevel: null,
        isAutoGetRole: '',
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        sort: null
      },
      
      // 标签页
      activeTabKey: 'info',
      
      currentPageSize: 20,
      current: 1,
      total: 0,
      pageSizeOptions: ["10", "20", "30","40"],
      sortField: "",
      sortOrder: "",
      // 子节点表格
      childColumns: [
        { title: '组织名称', dataIndex: 'orgName', key: 'orgName' },
        { title: '组织级别', dataIndex: 'orgLevel', key: 'orgLevel' },
        { title: '是否自动获取角色', dataIndex: 'isAutoGetRole', key: 'isAutoGetRole' },
        { title: '角色来源', dataIndex: 'roleOrigin', key: 'roleOrigin' },
        { title: '组织负责人', dataIndex: 'orgLeader', key: 'orgLeader' },
        { title: '组织角色', dataIndex: 'orgRole', key: 'orgRole' },
        { title: '排序', dataIndex: 'sort', key: 'sort' },
        { title: '最后修改人', dataIndex: 'lastModifierId', key: 'lastModifierId' },
        { title: '最后修改时间', dataIndex: 'lastModifyTime', key: 'lastModifyTime' },
        // { title: '操作', key: 'operation', scopedSlots: { customRender: 'operation' } }
      ],
      childTableData: [],
      selectedRowKeys: [],
      
      // 弹窗相关
      modalVisible: false,
      modalTitle: '',
      modalFormData: {
        id: null,
        pId: null,
        orgName: '',
        orgLevel: null,
        isAutoGetRole: '',
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        sort: null
      },
      modalAction: '', // addChild, addSibling, edit
      modalTargetNode: null,
      
      // Loading状态
      treeLoading: false,
      contentLoading: false,
      formLoading: false,
      tableLoading: false,
      modalLoading: false
    }
  },
  computed: {
    pageParam() {
      return {
        page: this.current,
        pageSize: this.currentPageSize,
        sortField: this.sortField,
        sortOrder: this.sortOrder
      };
    },
    // 右键菜单显示控制
    showAddChild() {
      if (!this.currentRightClickNode) return false
      return this.isRootNode(this.currentRightClickNode) || !this.isLeafNode(this.currentRightClickNode)
    },
    showAddSibling() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showEdit() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showDelete() {
      if (!this.currentRightClickNode) return false
      return !this.isRootNode(this.currentRightClickNode)
    },
    showRefresh() {
      return !!this.currentRightClickNode
    }
  },
  mounted() {
    this.user = JSON.parse( Cookie.get(process.env.VUE_APP_USER_KEY) || '{}')
  },
  created(){
    this.loadFullTreeData()
  },
  methods: {
    // 加载完整树形数据
    loadFullTreeData() {
      this.treeLoading = true
      getGenericPlanOrgInfoTree({}).then(res => {
        if (res.data.success) {
          this.treeData = this.convertToTreeFormat(res.data.data)
          this.expandedKeys = []
        }
       }); 
      this.treeLoading = false;
    },
    
    // 加载单个节点及子节点数据
    loadNodeAndChildren(nodeId) {
      this.treeLoading = true
      const data = {id:nodeId};
      getGenericPlanOrgInfoTree(data).then(res => {
        if (res.data.success) {
          this.updateNodeChildren(this.treeData, nodeId, res.data.data.children)
          this.expandNode(nodeId)
        }
       }); 
      this.treeLoading = false;
    },
    
    // 仅更新节点的children数据
    updateNodeChildren(tree, targetId, newChildren) {
      return tree.map(node => {
        if (node.id === targetId) {
          return {
            ...node,
            children: newChildren ? this.convertToTreeFormat(newChildren) : []
          }
        }
        if (node.children && node.children.length > 0) {
          return {
            ...node,
            children: this.updateNodeChildren(node.children, targetId, newChildren)
          }
        }
        return node
      })
    },
    
    // 转换为树形组件需要的格式
    convertToTreeFormat(data) {
      return data.map(item => ({
        ...item,
        key: item.id,
        title: item.orgName,
        children: item.children ? this.convertToTreeFormat(item.children) : []
      }))
    },
    
    // 树形节点选择
    handleTreeSelect(selectedKeys, info) {
      const node = info.node?.dataRef
      if (!node) {
        this.selectedNode = null
        this.selectedKeys = []
        return
      }
      
      if (this.isRootNode(node)) {
        this.selectedKeys = []
        this.selectedNode = null
        return
      }
      
      this.selectedKeys = selectedKeys
      this.selectedNode = node
      this.activeTabKey = 'info'
      this.loadNodeDetail(node.id)
    },
    
    // 树形节点展开/折叠事件
    handleTreeExpand(expandedKeys) {
      this.expandedKeys = expandedKeys
    },
    
    // 强制展开指定节点
    expandNode(nodeId) {
      if (!this.expandedKeys.includes(nodeId)) {
        this.expandedKeys = [...this.expandedKeys, nodeId]
      }
    },
    
    // 加载节点详情
    loadNodeDetail(id) {
	    this.contentLoading = true
      getGenericPlanOrgInfoById({id:id}).then(res => {
        if (res.data.success) {
          this.formData = { ...res.data.data }
          this.loadChildTableData(id)
        }
       }); 
      this.contentLoading = false;
    },

    //表格分页
    onPaginationChange(page, pageSize) {
      this.current = page;
      this.currentPageSize = pageSize;
      if (this.selectedNode) {
        this.loadChildTableData(this.selectedNode.id)
      }
    },
    onShowSizeChange(page, pageSize) {
      this.current = page;
      this.currentPageSize = pageSize;
      if (this.selectedNode) {
        this.loadChildTableData(this.selectedNode.id)
      }
    },
    
    // 加载子节点表格数据
    loadChildTableData(id) {
      this.tableLoading = true
      getGenericPlanOrgInfoChildById({id:id},this.pageParam).then(res => {
        if (res.data.success) {
          this.total = res.data.data.size;
          this.childTableData = res.data.data.list;
          this.selectedRowKeys = []
        }
       }); 
      this.tableLoading = false;
    },
    
    // 标签页切换
    handleTabChange(key) {
      this.activeTabKey = key
      if (key === 'children' && this.selectedNode) {
        this.loadChildTableData(this.selectedNode.id)
      }
    },
    
    // 表单提交（标签页操作，刷新全树）
    handleFormSubmit() {
      this.$refs.detailFormRef.validateFields((err) => {
        if (!err) {
          // 校验通过，执行提交逻辑
          this.formLoading = true;
          if (this.formData.id) {
              updateGenericPlanOrgInfo(this.formData).then(res => {
              if (res.data.success) {
                  this.$message.success('修改成功')
                  const currentExpanded = [...this.expandedKeys]
                  this.loadFullTreeData()
                  this.expandedKeys = currentExpanded
                  if (this.selectedNode) {
                    this.loadNodeDetail(this.selectedNode.id)
                  }
              } else {
                  this.$message.error(res.data.message);
              }
              this.formLoading = false;
              });
          } else {
              addGenericPlanOrgInfo(this.formData).then(res => {
                if (res.data.success) {
                  this.$message.success('新增成功')
                  const currentExpanded = [...this.expandedKeys]
                  this.loadFullTreeData()
                  this.expandedKeys = currentExpanded
                  if (this.selectedNode) {
                    this.loadNodeDetail(this.selectedNode.id)
                  }
                } else {
                  this.$message.error(res.data.message);
                }
                this.formLoading = false;
              });
          }
        } else {
          this.$message.error('表单校验失败，请检查输入');
        }
      });
    },
  
    
    // 右键菜单点击处理
    handleContextMenuClick({ key }) {
      const node = this.currentRightClickNode
      if (!node) return
      
      this.contextMenuVisible = false
      
      switch (key) {
        case 'addChild':
          this.openAddChildModal(node)
          break
        case 'addSibling':
          this.openAddSiblingModal(node)
          break
        case 'edit':
          this.openEditModal(node)
          break
        case 'delete':
          this.handleRightClickDelete(node)
          break
        case 'refresh':
          this.loadNodeAndChildren(node.id)
          break
      }
    },
    
    // 打开新增子节点弹窗
    openAddChildModal(parentNode) {
      this.modalAction = 'addChild'
      this.modalTargetNode = parentNode
      this.modalTitle = '新增子节点'
      this.modalFormData = {
        id: null,
        pId: parentNode.id,
        orgName: '',
        orgLevel: parentNode.orgLevel + 1,
        isAutoGetRole: '1',
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        sort: null
      }
      this.modalVisible = true
    },
    
    // 打开新增同级节点弹窗
    openAddSiblingModal(node) {
      this.modalAction = 'addSibling'
      this.modalTargetNode = node
      this.modalTitle = '新增同级节点'
      this.modalFormData = {
        id: null,
        pId: node.pId,
        orgName: '',
        orgLevel: node.orgLevel,
        isAutoGetRole: '1',
        roleOrigin: '',
        orgLeader: '',
        orgRole: '',
        remark: '',
        sort: null
      }
      this.modalVisible = true
    },
    
    // 打开编辑节点弹窗
    openEditModal(node) {
      this.modalAction = 'edit'
      this.modalTargetNode = node
      this.modalTitle = '修改节点'
      this.modalFormData = { ...node }
      this.modalVisible = true
    },
    
    // 弹窗提交处理
    handleModalSubmit() {
      this.$refs.modalFormRef.validateFields((err) => {
        if (!err) {
          this.modalLoading = true;
          if (this.modalAction === 'edit') {
            updateGenericPlanOrgInfo(this.modalFormData).then(res => {
              if (res.data.success) {
                this.$message.success('修改成功')
                this.loadNodeAndChildren(this.modalTargetNode.pId)
                this.expandNode(this.modalTargetNode.pId)
                this.modalVisible = false
              } else {
                this.$message.error(res.data.message);
              }
              this.modalLoading = false
            });
          } else {
            addGenericPlanOrgInfo(this.modalFormData).then(res => {
              if (res.data.success) {
                this.$message.success('新增成功')
                this.loadNodeAndChildren(this.modalTargetNode.id)
                this.expandNode(this.modalTargetNode.id)
                this.modalVisible = false
              } else {
                this.$message.error(res.data.message);
              }
              this.modalLoading = false
            });
          }
        } else {
          this.$message.error('表单校验失败，请检查输入');
        }
      });
    },
    
    // 右键删除节点
    handleRightClickDelete(node) {
      Modal.confirm({
        title: '确认删除',
        content: `确定要删除节点吗？`,
        okText: '确定',
        cancelText: '取消'
      })
      this.treeLoading = true
      deleteInfoByIds(node.id).then(res => {
        if (res.data.success) {
          this.$message.success('删除成功')
          this.loadNodeAndChildren(node.pId)
          this.expandNode(node.pId)
          this.selectedKeys = []
          this.selectedNode = null
        } else {
          this.$message.error(res.data.message);
        }
      }); 
      this.treeLoading = false
    },
    
    // 表格行选择变化
    handleRowSelectionChange(keys) {
      this.selectedRowKeys = keys
    },
    
    // 表格编辑子节点
    // handleEditChild(record) {
    //   this.formData = { ...record }
    //   this.activeTabKey = 'info'
    // },

     // 表格新增按钮处理
     handleAddChildFromTable() {
	    if (!this.selectedNode) return;
	      this.openAddChildModal(this.selectedNode);
     },

    // 表格编辑按钮处理
    handleEditFromTable() {
      const selectedRecord = this.childTableData.find(
	      item => item.id === this.selectedRowKeys[0]
      );
      if (selectedRecord) {
	      this.openEditModal(selectedRecord);
      }
    },
    
    // 表格删除子节点
    // handleDeleteChild(record) {
    //   Modal.confirm({
    //     title: '确认删除',
    //     content: `确定要删除节点吗？`,
    //     okText: '确定',
    //     cancelText: '取消'
    //   })
    //   this.tableLoading = true
    //   deleteInfoByIds(record.id).then(res => {
    //     if (res.data.success) {
    //       this.$message.success('删除成功')
    //       this.loadFullTreeData()
    //       if (this.selectedNode) {
    //         this.expandNode(this.selectedNode.id)
    //         this.loadChildTableData(this.selectedNode.id)
    //       }
    //     } else {
    //       this.$message.error(res.data.message);
    //     }
    //   });
    //   this.tableLoading = false
    // },
    
    // 表格批量删除
    handleBatchDelete() {
      if (this.selectedRowKeys.length === 0){
        this.$message.error("请选择要删除的行数据");
        return
      } 
      Modal.confirm({
        title: '批量删除',
        content: `确定要删除吗？`,
        okText: '确定',
        cancelText: '取消'
      })
      this.tableLoading = true
      deleteInfoByIds(this.selectedRowKeys.join(',')).then(res => {
        if (res.data.success) {
          this.$message.success('批量删除成功')
          this.loadFullTreeData()
          if (this.selectedNode) {
            this.expandNode(this.selectedNode.id)
            this.loadChildTableData(this.selectedNode.id)
          }
        } else {
          this.$message.error(res.data.message);
        }
      });
      this.tableLoading = false
    },
    
    // 右键菜单显示/隐藏
    handleRightClick({ event, node }) {
      event.preventDefault();
      this.currentRightClickNode = node.dataRef;
      this.selectedKeys = [node.key];
      this.selectedNode = node.dataRef;
      // 更新锚点位置
      this.anchorX = event.clientX;
      this.anchorY = event.clientY;
      this.contextMenuVisible = true;
    },
    
    handleContextMenuVisibleChange(visible) {
      this.contextMenuVisible = visible;
      if (!visible) {
        this.currentRightClickNode = null
      }
    },
    
    // 根节点判断
    isRootNode(node) {
      return node.orgLevel === 0 && node.id === 0
    },
    
    // 叶子节点判断
    isLeafNode(node) {
      return node.orgLevel === 3 && (!node.children || node.children.length === 0)
    },
    
    // 自定义节点渲染
    titleRender(node) {
      return node.orgName
    },

    //选择组件参数
    defaultData(){
      const obj = {
          currentUser:this.user.userid, 
          multiple: true,
      }
      return obj
    },
    //获取选择组件数据并赋值
    getdata(data,item){
			if(data && data.length > 0){
          let arr = data.map(obj => {
              return obj.empCode
          })
          this.formData.orgRole = arr.toString()
      }else{
          this.formData.orgRole = ''
      }
		},
    //获取选择组件数据并赋值
    getdata2(data,item){
			if(data && data.length > 0){
          let arr = data.map(obj => {
              return obj.empCode
          })
          this.modalFormData.orgRole = arr.toString()
      }else{
          this.modalFormData.orgRole = ''
      }
		},
  }
}
</script>

<style scoped>
.org-management-container {
  height: 100vh;
  overflow: hidden;
}

.full-height {
  height: 100%;
}

.tree-container {
  height: 100%;
  border-right: 1px solid #e8e8e8;
  padding: 16px;
  overflow: auto;
}

.content-container {
  height: 100%;
  padding: 16px;
  overflow: auto;
}

.table-operations {
  margin-bottom: 16px;
  display: flex;
  gap: 8px;
}

.ant-spin-nested-loading {
  position: relative;
  z-index: 1;
}
</style>
