<template>
  <div class="org-management-container">
    <a-row class="full-height">
      <a-col :span="7" class="tree-container">
        <!-- æœç´¢æ¡† -->
        <div class="tree-search-container">
          <a-input
            v-model="searchValue"
            placeholder="è¾“å…¥ç»„ç»‡åç§°æœç´¢"
            allowClear
            @change="handleSearch"
            @pressEnter="handleSearch"
          >
            <a-icon slot="prefix" type="search" />
          </a-input>
        </div>
        
        <a-spin :spinning="treeLoading" tip="åŠ è½½ä¸­...">
          <a-tree
            ref="treeRef"
            v-if="treeData.length"
            :treeData="treeData"
            :expandedKeys="expandedKeys"
            :selectedKeys="selectedKeys"
            @select="handleTreeSelect"
            @expand="handleTreeExpand"
            @rightClick="handleRightClick"
            :titleRender="titleRender"
            :disabled="treeLoading"
            :autoExpandparent="false"
          />
        </a-spin>
      </a-col>
      <!-- å³ä¾§å†…å®¹åŒºåŸŸï¼ˆåŽŸæœ‰ä»£ç ä¸å˜ï¼‰ -->
    </a-row>
  </div>
</template>

<script>
export default {
  name: 'genericPlanOrgInfo',
  components: {},
  data() {
    return {
      searchValue: '',
      treeData: [],
      treeLoading: false,
      expandedKeys: [],
      selectedKeys: [],
      selectedNode: null
      // å…¶ä»–åŽŸæœ‰æ•°æ®...
    };
  },
  methods: {
    // æ ¸å¿ƒï¼šæœç´¢å¤„ç†ï¼ˆä»…å±•å¼€ä¸Šçº§èŠ‚ç‚¹ï¼Œä¸é€‰ä¸­ã€ä¸å±•å¼€è‡ªèº«/ä¸‹çº§ï¼‰
    handleSearch() {
      const keyword = this.searchValue.trim();
      if (!keyword) {
        // æ— æœç´¢å†…å®¹æ—¶ä¸ä¿®æ”¹ä»»ä½•çŠ¶æ€
        return;
      }
      
      const expandKeys = new Set();
      // é€’å½’æ”¶é›†æ‰€æœ‰åŒ¹é…èŠ‚ç‚¹çš„ä¸Šçº§èŠ‚ç‚¹IDï¼ˆæŽ’é™¤åŒ¹é…èŠ‚ç‚¹è‡ªèº«ï¼‰
      this.collectParentKeys(this.treeData, keyword, expandKeys);
      
      if (expandKeys.size > 0) {
	    this.expandedKeys = Array.from(expandKeys);
	  } else {
	    // å¯é€‰ï¼šæç¤ºç”¨æˆ·â€œæ— éœ€è¦å±•å¼€çš„èŠ‚ç‚¹â€ï¼ˆéžå¿…é¡»ï¼Œçœ‹äº§å“éœ€æ±‚ï¼‰
	    // this.$message.info('æœªæ‰¾åˆ°éœ€è¦å±•å¼€çš„ä¸Šçº§èŠ‚ç‚¹');
	  }
    },

    // é€’å½’æŸ¥æ‰¾åŒ¹é…èŠ‚ç‚¹ï¼Œå¹¶æ”¶é›†å…¶æ‰€æœ‰ä¸Šçº§èŠ‚ç‚¹IDï¼ˆä¿®å¤æ ¸å¿ƒé€»è¾‘ï¼‰
    collectParentKeys(nodes, keyword, expandKeys) {
      if (!nodes || !nodes.length) return false;

      let hasMatchedChild = false;
      nodes.forEach(node => {
        // 1. åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åŒ¹é…
        const isMatched = node.orgName && node.orgName.toLowerCase()
          .includes(keyword.toLowerCase());

        // 2. é€’å½’å¤„ç†å­èŠ‚ç‚¹ï¼ˆä»…æ”¶é›†ä¸Šçº§ï¼Œä¸å¤„ç†ä¸‹çº§å±•å¼€ï¼‰
        const childMatched = this.collectParentKeys(node.children, keyword, expandKeys);
        hasMatchedChild = hasMatchedChild || childMatched;

        // ðŸ”´ æ ¸å¿ƒä¿®å¤ï¼šä»…å½“ã€Œå­èŠ‚ç‚¹åŒ¹é…ã€æ—¶ï¼Œæ‰åŠ å…¥å½“å‰èŠ‚ç‚¹ï¼ˆå³åŒ¹é…èŠ‚ç‚¹çš„ä¸Šçº§ï¼‰
        // å®Œå…¨æŽ’é™¤ã€Œå½“å‰èŠ‚ç‚¹åŒ¹é…ã€çš„æƒ…å†µï¼Œé¿å…åŒ¹é…èŠ‚ç‚¹è‡ªèº«è¢«åŠ å…¥
        if (childMatched) {
          expandKeys.add(node.id); // åªåŠ åŒ¹é…èŠ‚ç‚¹çš„çˆ¶/ç¥–èŠ‚ç‚¹ï¼Œä¸åŠ åŒ¹é…èŠ‚ç‚¹è‡ªèº«
        }
      });

      // è¿”å›žã€Œå½“å‰èŠ‚ç‚¹æ˜¯å¦åŒ¹é…ã€æˆ–ã€Œå­èŠ‚ç‚¹æ˜¯å¦åŒ¹é…ã€ï¼ˆä¾›çˆ¶èŠ‚ç‚¹åˆ¤æ–­ï¼‰
      return hasMatchedChild || (nodes.some(node => 
        node.orgName && node.orgName.toLowerCase().includes(keyword.toLowerCase())
      ));
    },
  }
};
</script>

<style scoped>
.tree-search-container {
  margin-bottom: 16px;
}
.org-management-container {
  background-color: #fff;
  height: 100%;
  overflow: hidden;
}
.full-height {
  height: 100%;
}
.tree-container {
  height: calc(100vh - 200px);
  border: 1px solid #e8ecef;
  padding: 16px;
  overflow: auto;
}
::v-deep .ant-tree-node-content-wrapper {
  &.ant-tree-node-selected {
    background-color: #e6f7ff;
  }
}
</style>
